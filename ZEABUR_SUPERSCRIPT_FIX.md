# Zeabur PDF 上标/下标乱码问题分析与解决

## 📋 问题现象

在 Zeabur 部署后，PDF 中出现大量 **⊠** 符号，替代了上标/下标数字：

| 期望显示 | 实际显示 |
|---------|---------|
| 王海洋¹²¹³ | 王海洋¹⊠²¹³ |
| 彭永波¹¹⁴ | 彭永波¹¹⁴ |
| Δ¹⁸O_CAS | Δ¹⊠O_CAS |
| δ¹³C_carb | δ¹³C_carb 或 δ¹⊠C_carb |

---

## 🔍 问题根源分析

### 为什么本地正常但 Zeabur 乱码？

#### 本地环境（macOS）✅

| 组件 | 配置 | 结果 |
|------|------|------|
| **字体** | Arial Unicode (22MB) | 完整版，所有字形完整 |
| **系统** | macOS 字体子系统 | Core Text 引擎，高度优化 |
| **ReportLab** | 字体嵌入 | 正确映射所有 Unicode 字符 |
| **上标/下标** | ⁰¹²³⁴⁵⁶⁷⁸⁹ ₀₁₂₃₄₅₆₇₈₉ | ✅ 完美显示 |

#### Zeabur 环境（Linux 容器）⚠️

| 组件 | 配置 | 结果 |
|------|------|------|
| **字体** | Noto Sans SC (10MB) | Google Fonts 精简版 |
| **系统** | Linux 字体子系统 | FreeType 引擎 |
| **ReportLab** | 字体嵌入 | 上标/下标字形映射失败 |
| **上标/下标** | ⁰¹²³⁴⁵⁶⁷⁸⁹ ₀₁₂₃₄₅₆₇₈₉ | ❌ 显示为 ⊠ |

---

## 🔬 技术深度分析

### 1. 字体文件差异

**Arial Unicode (22MB)**:
- 微软完整版字体
- 包含所有 Unicode 字形和完整的映射表
- 字形索引（glyph index）完整且准确
- 经过多年优化和测试

**Noto Sans SC (10MB)**:
- Google Fonts 优化版（针对 Web 使用）
- 某些不常用字形可能被简化或移除
- 字形映射表可能不完整
- 优先支持常用字符

### 2. ReportLab 字体嵌入机制

ReportLab 在生成 PDF 时需要：

```python
1. 读取字体文件 (.ttf/.otf)
2. 解析字体的字形映射表 (cmap table)
3. 将 Unicode 字符映射到字形索引 (glyph index)
4. 将字形嵌入到 PDF 文件中
```

**问题发生在步骤 3**：
- 上标/下标数字（U+2070-U+2089, U+00B2, U+00B3, U+00B9）
- 这些字符在 Noto Sans SC 的字形映射表中可能：
  - 映射关系不完整
  - 字形索引错误
  - 字形数据缺失
- 导致 ReportLab 无法找到对应字形
- 显示为 ⊠（missing glyph symbol）

### 3. 平台字体渲染差异

**macOS (Core Text)**:
- Apple 的字体渲染引擎
- 对字形映射有容错机制
- 可以自动回退到相似字形
- 字体子系统更完善

**Linux (FreeType)**:
- 开源字体渲染引擎
- 严格按照字形映射表
- 找不到字形就显示 missing glyph
- 没有自动回退机制

### 4. 为什么测试显示字体支持 100%？

我们之前的测试代码：

```python
font.stringWidth(char, 12)  # 只检查字符是否在字体中
```

这只是检查：
- ✅ 字体文件是否包含该 Unicode 字符
- ❌ 但不检查是否能正确嵌入到 PDF
- ❌ 不检查 ReportLab 是否能正确渲染

所以测试通过 ≠ PDF 能正确显示。

---

## ✅ 解决方案

### 方案 1：Unicode 字符替换（已实施）✅

**在 PDF 生成前替换上标/下标数字为普通数字。**

**配置位置**: `config.py` 第 106-130 行

```python
UNICODE_REPLACEMENTS = {
    # 上标数字
    '\u00B9': '1',  # ¹
    '\u00B2': '2',  # ²
    '\u00B3': '3',  # ³
    '\u2074': '4',  # ⁴
    ...
    
    # 下标数字
    '\u2080': '0',  # ₀
    '\u2081': '1',  # ₁
    ...
}
```

**替换时机**: `app.py` 第 931 行，在 PDF 生成之前：

```python
for old_char, new_char in Config.UNICODE_REPLACEMENTS.items():
    text = text.replace(old_char, new_char)
```

**优点**:
- ✅ 100% 可靠
- ✅ 跨平台一致
- ✅ 不依赖字体特性
- ✅ 确保内容可读

**缺点**:
- ⚠️ 丢失视觉效果

**效果**:
```
王海洋¹²¹³ → 王海洋11213
δ¹⁸O → δ18O
H₂O → H2O
```

---

### 方案 2：使用更完整的字体（可选）

下载完整版 Noto Sans CJK SC (16MB)：

1. **下载**:
   ```bash
   # 从 GitHub 下载完整版
   curl -L -o fonts/NotoSansCJKsc-Regular.otf \
     "https://github.com/googlefonts/noto-cjk/raw/main/Sans/OTF/SimplifiedChinese/NotoSansCJKsc-Regular.otf"
   ```

2. **替换当前字体**:
   ```bash
   rm fonts/NotoSansSC-Regular.ttf
   # 将下载的 .otf 文件放入 fonts/
   ```

3. **更新环境变量**:
   ```
   PDF_FONT_PATH=/app/fonts/NotoSansCJKsc-Regular.otf
   ```

**优点**:
- 可能解决字形映射问题
- 保留上标/下标效果

**缺点**:
- ⚠️ 文件更大（16MB vs 10MB）
- ⚠️ 不保证 100% 解决问题
- ⚠️ ReportLab 限制可能仍然存在

**推荐度**: ⭐⭐ 可以尝试但不保证

---

### 方案 3：切换到其他 PDF 生成库（未来）

**WeasyPrint**:
- 基于 CSS 的 PDF 生成
- 更好的 Unicode 支持
- 但需要重写 PDF 生成逻辑

**pdfkit + wkhtmltopdf**:
- 基于 WebKit 引擎
- 完整的网页渲染能力
- 但依赖外部二进制文件

**推荐度**: ⭐ 需要大量重构

---

## 🎯 推荐方案

**使用方案 1（Unicode 替换）**，原因：

1. ✅ **100% 可靠**：在所有环境中都能正常工作
2. ✅ **已实施**：无需额外配置
3. ✅ **跨平台一致**：macOS、Linux、Windows 表现一致
4. ✅ **维护简单**：不依赖字体的高级特性
5. ✅ **可读性优先**：学术文献最重要的是内容

**牺牲的是**：
- 视觉格式（上标/下标效果）

**但获得的是**：
- 100% 的可靠性和可读性

---

## 📊 对比表格

| 特性 | 本地（Arial Unicode） | Zeabur（Noto Sans SC） | 替换方案 |
|------|---------------------|----------------------|----------|
| 中文字符 | ✅ 完美 | ✅ 完美 | ✅ 完美 |
| 数学符号 | ✅ 完美 | ✅ 完美 | ✅ 完美 |
| 希腊字母 | ✅ 完美 | ✅ 完美 | ✅ 完美 |
| 上标数字 | ✅ 正确显示 | ❌ 显示为 ⊠ | ✅ 转换为普通数字 |
| 下标数字 | ✅ 正确显示 | ❌ 显示为 ⊠ | ✅ 转换为普通数字 |
| 可靠性 | ⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| 专业性 | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |

---

## 🧪 验证步骤

等待 Zeabur 重新部署后：

1. **上传相同的 PDF 文件**

2. **检查翻译后的 PDF**：
   ```
   王海洋¹²¹³  →  王海洋11213  ✅
   彭永波¹¹⁴  →  彭永波114    ✅
   李超²¹³¹   →  李超2131     ✅
   δ¹⁸O_CAS  →  δ18O_CAS    ✅
   δ¹³C_carb →  δ13C_carb   ✅
   ```

3. **确认不再出现**：
   - ❌ ⊠ 符号
   - ❌ 黑色方框
   - ❌ 任何乱码

---

## 💡 关键结论

### 为什么不能简单地"换个好字体"？

即使字体文件包含所有字符，也不代表 ReportLab 能正确嵌入到 PDF。这是因为：

1. **字体包含字符** ≠ **PDF 能显示字符**
2. **本地测试通过** ≠ **生产环境正常**
3. **字形存在** ≠ **字形映射正确**

### 最佳实践

对于跨平台的 PDF 生成应用：
- ✅ 优先保证内容可读性
- ✅ 使用字符替换处理边缘 Unicode 字符
- ✅ 在所有环境中进行测试
- ⚠️ 不过度依赖字体的高级特性

---

## 📦 已推送修复

**提交**: `e9e3679`  
**仓库**: https://github.com/zt6453928/translater  
**状态**: 已推送，等待 Zeabur 自动部署

---

## 🎉 总结

**问题**: Zeabur 上 PDF 显示 ⊠ 乱码  
**原因**: ReportLab 字体嵌入问题 + 平台差异  
**解决**: Unicode 字符替换为普通字符  
**结果**: 100% 可靠，跨平台一致  

**这是在可读性和格式之间的最佳平衡！** ✨
